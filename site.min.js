"use strict";
!function () {
    let a = "";
    $(document).delegate(".bookmark .search-box input[type=search]", "input", function () {
        a = $(this).val();
        let e = [];
        $(".bookmark .category-box .category.active").each(function () {
            e.push($(this).text())
        }), $.ajax({
            type: "get",
            url: "/bookmark/search",
            traditional: !0,
            data: {title: a, categories: e}
        }).done(function (e) {
            if (e.success) {
                $(".bookmark .search-box .search-result").show();
                var t = [];
                for (const o of e.data) t.push(`<li>${o}</li>`);
                $(".bookmark .search-box .search-result ul").html(t.join(""))
            }
        })
    }), $(document).delegate(".bookmark .search-box input[type=search]", "keyup", function (t) {
        if (13 === t.keyCode) {
            t = $(this).val();
            let e = [];
            $(".bookmark .category-box .category.active").each(function () {
                e.push("categories=" + encodeURIComponent($(this).text()))
            }), "" === t.trim() && 0 === e.length ? $.pjax({
                url: "/bookmark.html",
                container: ".blog-body"
            }) : "" === t.trim() && 0 !== e.length ? $.pjax({
                url: "/bookmark.html?" + e.join("&"),
                container: ".blog-body"
            }) : "" !== t.trim() && 0 === e.length ? $.pjax({
                url: "/bookmark.html?title=" + encodeURIComponent(t),
                container: ".blog-body"
            }) : $.pjax({url: `/bookmark.html?title=${encodeURIComponent(t)}&` + e.join("&"), container: ".blog-body"})
        }
    }), $(document).delegate(".bookmark .search-box .search-result ul li", "click", function () {
        var e = $(this).text();
        let t = [];
        $(".bookmark .category-box .category.active").each(function () {
            t.push("categories=" + encodeURIComponent($(this).text()))
        }), 0 === t.length ? $.pjax({
            url: "/bookmark.html?title=" + encodeURIComponent(e),
            container: ".blog-body"
        }) : $.pjax({url: `/bookmark.html?title=${encodeURIComponent(e)}&` + t.join("&"), container: ".blog-body"})
    }), $(document).delegate(".bookmark .search-box input[type=search]", "blur", function () {
        setTimeout(function () {
            $(".bookmark .search-box .search-result").hide()
        }, 300)
    }), $(document).delegate(".bookmark .search-box input[type=search]", "focus ", function () {
        0 < $(".bookmark .search-box .search-result ul li").length && $(".bookmark .search-box .search-result").show()
    }), $(document).delegate(".bookmark .search-box input[type=search]", "keydown", function (e) {
        var t, o = $(".bookmark .search-box .search-result ul li"),
            n = $(".bookmark .search-box .search-result ul li.selected");
        40 === e.keyCode ? (e.preventDefault(), 0 === n.length ? ((t = o.first()).addClass("selected"), $(this).val(t.text())) : $(".bookmark .search-box .search-result ul li:last").hasClass("selected") ? (o.removeClass("selected"), $(this).val(a)) : (t = n.next(), o.removeClass("selected"), 0 < t.length && (t.addClass("selected"), $(this).val(t.text())))) : 38 === e.keyCode && (e.preventDefault(), 0 === n.length ? ((t = o.last()).addClass("selected"), $(this).val(t.text())) : $(".bookmark .search-box .search-result ul li:first").hasClass("selected") ? (o.removeClass("selected"), $(this).val(a)) : (e = n.prev(), o.removeClass("selected"), 0 < e.length && (e.addClass("selected"), $(this).val(e.text()))))
    }), $(document).delegate(".bookmark .category-box .category", "click", function () {
        $(this).hasClass("active") ? $(this).removeClass("active") : $(this).addClass("active")
    }), $(document).delegate("form.bookmark-create", "submit", function () {
        var e = new FormData(this);
        let n = $(this);
        return $(this).find("button[lay-submit]").addClass("layui-btn-disabled").attr("disabled", "disabled").html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop layui-font-12"></i> 正在提交'), $.ajax({
            url: n.attr("action"),
            processData: !1,
            contentType: !1,
            data: e,
            type: "post"
        }).done(function (e, t, o) {
            e.success ? (n[0].reset(), layer.closeAll(), $.pjax({
                url: "/bookmark.html",
                container: ".blog-body"
            })) : layer.alert(e.msg)
        }).fail(ajaxFail), !1
    }), $(document).delegate(".bookmark-setting[data-id]", "click", function () {
        var e = $(this).data("id");
        let t = layer.load(), o = 600 < $(window).width() ? "600px" : "100%";
        $.ajax({url: "/bookmark/update/" + e, type: "get"}).done(function (e) {
            "object" == typeof e ? e.success || layer.msg(e.msg) : layer.open({
                type: 1,
                content: e,
                area: o,
                success: function () {
                    form.render()
                }
            })
        }).always(function () {
            layer.close(t)
        }).fail(ajaxFail)
    }), $(document).delegate("form.bookmark-create button[data-delete]", "click", function () {
        let e = layer.load();
        $.ajax({url: "/bookmark/delete", type: "post", data: {id: $(this).data("delete")}}).done(function () {
            layer.closeAll(), $.pjax({url: "/bookmark.html", container: ".blog-body"})
        }).always(function () {
            layer.close(e)
        })
    })
}(), $(document).delegate(".comments-area .load-more button", "click", function () {
    let n = $(this).parents(".comments-area"), a = $(this).parent(), i = $(this).parents().find(".comment-count span");
    var e = $(this).parent().data("loadingIco"),
        e = (a.html(`<img src="${e}" class="comment-loading" alt="loading"/>`), parseInt($(this).data("pageIndex"))),
        t = parseInt($(this).data("pageSize")), o = $(this).data("pageRequest");
    $(this);
    $.ajax({url: o, type: "get", data: {pageIndex: e + 1, pageSize: t}}).done(function (e, t, o) {
        n.append(e), a.remove(), i.text(o.getResponseHeader("commentCount")), $("time.timeago").relativeTime(), lightCode()
    }).fail(ajaxFail)
}), $(document).delegate("form.comment-form :input:not(textarea)", "keydown", function (e) {
    return "Enter" != e.key
}), $(document).delegate("form.comment-form", "submit", function () {
    event.preventDefault();
    var e = new FormData(this);
    let s = $(this), l = $(this).parents(".comment-block").find(".comment-count span");
    $(this).find("button.layui-btn.layui-btn-sm").addClass("layui-btn-disabled").attr("disabled", "disabled").html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop layui-font-12"></i> 发送'), $.ajax({
        url: s.attr("action"),
        processData: !1,
        contentType: !1,
        data: e,
        type: "post"
    }).done(function (e, t, o) {
        var n, a, i;
        e.hasOwnProperty("success") && !1 === e.success ? layer.msg(e.msg, {
            icon: 2,
            anim: 6
        }) : (n = s.clone(), i = (a = s.parents(".comment-block")).find(".comments-area:first"), a.find(".comments-area").html(e), s.remove(), n.find("textarea").val(""), n.find("button.layui-btn.layui-btn-sm").removeClass("layui-btn-disabled").removeAttr("disabled").html("发送"), n.find("input[name=replyId]").val(""), n.find(".comment-btn-close").hide(), n.find(".comment-btn-close").unbind("click"), i.before(n), l.text(o.getResponseHeader("commentCount")), $("time.timeago").relativeTime(), lightCode())
    }).always(function () {
        s.find("button.layui-btn.layui-btn-sm").removeClass("layui-btn-disabled").removeAttr("disabled").html("发送")
    })
}), $(document).delegate(".comment-count button.refresh", "click", function () {
    let n = $(this).parents(".comment-block").find(".comments-area");
    var e = $(this).data("refresh") + "?t=" + (new Date).getTime();
    let a = $(this).parent().find("span"), t = layer.load();
    $.ajax({url: e, type: "get"}).done(function (e, t, o) {
        n.html(e), a.text(o.getResponseHeader("commentCount")), $("time.timeago").relativeTime(), lightCode()
    }).fail(ajaxFail).always(function () {
        layer.close(t)
    })
}), $(document).delegate(".footer-action-item[data-image]", "click", function () {
    let n = $(this).parents().find("textarea.comment-form-editor");
    layer.prompt({title: "请输入网络图片地址"}, function (e, t) {
        let o;
        try {
            o = new URL(e)
        } catch {
            return void layer.msg("请输入正确的地址嗷~")
        }
        "https:" !== o.protocol ? layer.msg("使用https协议的网络图片嗷~") : (e = `![](${o.toString()})`, n.val(n.val() + "\r\n" + e), layer.close(t))
    })
}), $(document).delegate(".comments-area blockquote.comment-item button.btn-reply", "click", function () {
    var e = $(this).parents(".comment-block").find("form.comment-form");
    let t = e.clone(), o = (e.remove(), $(this));
    t.find("input[name=replyId]").val($(this).data("replyId")), t.find(".comment-btn-close").show(), t.find(".comment-btn-close").bind("click", function () {
        t.find("input[name=replyId]").val(""), o.parents(".comments-area").before(t), $(this).hide(), $(this).unbind("click")
    }), $(this).parents(".comment-block blockquote.comment-item:first").find(".detail > .comment-content:first").after(t)
}), async function () {
    var e;
    codeBlockTools(), moment.locale("zh-cn"), new LazyLoad({}), "granted" !== Notification.permission && (e = await Notification.requestPermission(function (e) {
        "granted" === e && console.info("通知已授权")
    }), console.log(e))
}(), $.fn.relativeTime = function () {
    this.each(function (e) {
        var t, o;
        void 0 === $(this).data("timeStatus") && (o = $(this).attr("datetime"), t = $(this).text(), o = moment(o, "YYYY/MM/DD HH:mm:ss").fromNow(), $(this).text(o).attr("title", t).data("timeStatus", "loaded"))
    })
};
const dpzOption = {
    webApiBaseAddress: document.querySelector("meta[name=web-api-base-address]").content,
    CDNBaseAddress: document.querySelector("meta[name=cdn-base-address]").content,
    isDark: window.matchMedia("(prefers-color-scheme: dark)").matches
};

function loadImages(t) {
    var n = [];
    for (let e = 0; e < t.length; e++) {
        let o = t[e];
        var a = new Promise((e, t) => {
            o.complete ? e(o) : (o.addEventListener("load", function () {
                (o.complete ? e : t)(o)
            }), o.addEventListener("error", function () {
                console.warn(`the image [${o.src}] loaded error.`), t(o)
            }))
        });
        n.push(a)
    }
    return Promise.all(n)
}

function lightCode() {
    document.querySelectorAll("pre code").forEach(e => {
        Prism.highlightElement(e)
    }), codeBlockTools()
}

function codeBlockTools() {
    $("pre[class*=language-]").wrap('<div class="code-area" style="position: relative"></div>');
    var e = $('<i class="fa fa-angle-up fa-fw code-expand" aria-hidden="true" title="折叠"></i>'),
        e = ($(".code-area").prepend(e), $(".code-expand").on("click", function () {
            $(this).parent().hasClass("code-closed") ? ($(this).siblings("pre").find("code").show(), $(this).siblings("pre").find(".line-highlight").show(), $(this).parent().removeClass("code-closed")) : ($(this).siblings("pre").find("code").hide(), $(this).siblings("pre").find(".line-highlight").hide(), $(this).parent().addClass("code-closed"))
        }), $('<i class="fa fa-copy fa-fw code_copy" title="复制代码" aria-hidden="true"></i>')),
        t = $('<div class="codecopy_notice"></div>');
    $(".code-area").prepend(e), $(".code-area").prepend(t), $(".code-area .fa-copy").on("click", function () {
        var e = window.getSelection(), t = document.createRange();
        t.selectNodeContents($(this).siblings("pre").find("code")[0]), e.removeAllRanges(), e.addRange(t), e.toString();
        if (document.queryCommandSupported && document.queryCommandSupported("copy")) try {
            document.execCommand("copy"), layer.msg("复制成功")
        } catch (e) {
            layer.msg("复制失败")
        } else layer.msg("浏览器不支持");
        e.removeAllRanges()
    });
    e = $('<div class="code_lang" title="代码语言"></div>'), t = $("pre");
    t.before(e), t.each(function () {
        var e;
        for (e of $(this).prop("class").split(/\s+/)) if (e.startsWith("language")) {
            var t = e.replace("language-", "").trim();
            $(this).siblings(".code_lang").text(t);
            break
        }
    })
}

function outPutSuccess(e) {
    console.log(`%c Success %c [${moment().format("YYYY-MM-DD HH:mm:ss")}]  %c ` + e, "color: #bb0662; background: #030307; padding:5px 0;", "color: #fadfa3; background: #393d49; padding:5px 0", "font-weight:bold; color: black; background: #77f2e1; padding:5px 0;")
}

function outPutInfo(e) {
    console.log(`%c Info %c [${moment().format("YYYY-MM-DD HH:mm:ss")}]  %c ` + e, "color: #bb0662; background: #030307; padding:5px 0;", "color: #fadfa3; background: #393d49; padding:5px 0", "font-weight:bold; color: black; background: #fadfa3; padding:5px 0;")
}

function outPutError(e) {
    console.log(`%c Error %c [${moment().format("YYYY-MM-DD HH:mm:ss")}]  %c ` + e, "color: #bb0662; background: #030307; padding:5px 0;", "color: #fadfa3; background: #393d49; padding:5px 0", "font-weight:bold; color: black; background: red; padding:5px 0;")
}

function ajaxFail(e, t, o) {
    console.log(e), console.log(t), console.log(o), e.hasOwnProperty("responseJSON") && e.responseJSON.hasOwnProperty("success") && e.responseJSON.hasOwnProperty("msg") && !1 === e.responseJSON.success ? layer.alert(e.responseJSON.msg) : layer.msg("error:" + e.status)
}

async function initVideoPlayer() {
    var e, t, o = document.getElementById("video-player") || document.getElementById("m-video-player"),
        o = (null !== o && (o.style.marginBottom = "15px", t = await (await fetch(dpzOption.webApiBaseAddress + "/api/Video", {
            method: "GET",
            headers: {"Content-Type": "application/json"},
            mode: "cors"
        })).json(), e = Math.floor(Math.random() * t.length), new DPlayer({
            container: document.getElementById(o.id),
            danmaku: {api: "/history/chat/", id: t[e].id, maximum: 2e3, token: "token", user: "阿胖", bottom: "15%"},
            video: {url: t[e].m3u8, type: "hls"}
        })), document.querySelector("[data-video]"));
    null !== o && (t = JSON.parse(o.dataset.video), new DPlayer({
        container: o,
        danmaku: {api: "/history/chat/", id: t.id, maximum: 2e3, token: "token", user: "阿胖", bottom: "15%"},
        video: {url: t.url, type: "hls"}
    }))
}

async function initFetchContent() {
    for (let t of document.querySelectorAll("[data-request]")) (await fetch(t.dataset.request, {method: "GET"})).text().then(e => {
        t.innerHTML = e, $("time.timeago").relativeTime(), lightCode()
    })
}

function showNotify(e) {
    var t = {title: "", content: "", image: "https://cdn.dpangzi.com/logo.png"};
    return $.extend(t, e), "Notification" in window && "granted" === Notification.permission ? new Notification(t.title, {
        icon: t.image,
        body: t.content,
        lang: "zh-cn",
        tag: t.tag
    }) : null
}

!function () {
    $.ajax({url: "/account/GetUserInfo"}).done(function (e) {
        e.success && $(".blog-user").attr("href", "/account").find("img").attr({
            src: "" + e.data.avatar,
            title: e.data.name
        })
    }).fail(ajaxFail);
    let i = ".article.shadow .article-left img,.mumble-list .mumble-item .mumble-content img,.article-detail-content img,#cd-timeline .content img";
    $(document).delegate(i, "click", function () {
        let e = layer.load(1), a = $(i);
        loadImages(a).then(t => {
            var o = [];
            for (let e = 0; e < t.length; e++) {
                var n = t[e];
                o.push({src: n.src, w: n.naturalWidth, h: n.naturalHeight, title: n.alt})
            }
            var e = {
                index: a.index(this),
                bgOpacity: .7,
                showHideOpacity: !0,
                history: !0,
                getThumbBoundsFn: function (e) {
                    var e = document.querySelectorAll(i)[e],
                        t = window.pageYOffset || document.documentElement.scrollTop, e = e.getBoundingClientRect();
                    return {x: e.left, y: e.top + t, w: e.width}
                }
            };
            new PhotoSwipe(document.getElementById("gallery"), PhotoSwipeUI_Default, o, e).init()
        }).finally(() => layer.close(e))
    })
}(), layui.use(["element", "layer", "carousel", "util", "flow", "form", "upload"], function () {
    layui.element;
    let t = layui.layer, e = (layui.carousel, layui.flow), o = layui.util;
    layui.form;
    if (o.fixbar({
        bar1: "&#xe64a;", css: {bottom: 55}, click: function (e) {
            if ("bar1" === e) {
                let e = t.load(), n = (console.log(event), event.target || event.srcElement);
                $.ajax({url: "/Home/TodayWallpaper"}).done(function (e) {
                    var t, o = [];
                    for (t of e) o.push({
                        src: t.url.replaceAll("1920x1080", "UHD"),
                        w: 1920,
                        h: 1080,
                        title: t.copyRight
                    });
                    e = {
                        index: 0, bgOpacity: .7, showHideOpacity: !0, history: !0, getThumbBoundsFn: function (e) {
                            var t = window.pageYOffset || document.documentElement.scrollTop,
                                o = n.getBoundingClientRect() || {left: 0, top: 0, width: 0};
                            return {x: o.left, y: o.top + t, w: o.width}
                        }
                    };
                    new PhotoSwipe(document.getElementById("gallery"), PhotoSwipeUI_Default, o, e).init()
                }).always(function () {
                    t.close(e)
                })
            }
        }
    }), e.lazyimg(), !1 === layui.device().mobile) try {
        const a = document.querySelector("#can-back-round");
        var n = a.getBoundingClientRect();
        a.width = n.width, a.height = n.height;
        const i = new RaindropFX({
            canvas: a,
            background: dpzOption.isDark ? "https://cdn.dpangzi.com/wallpaper.jpg" : dpzOption.CDNBaseAddress + "/../images/background.jpg"
        });
        window.onresize = () => {
            var e = a.getBoundingClientRect();
            i.resize(e.width, e.height)
        }, i.start()
    } catch (e) {
        console.log(e)
    }
}), async function () {
    let e = (new signalR.HubConnectionBuilder).withUrl("/notification").withAutomaticReconnect().build();
    try {
        await e.start(), await e.invoke("Init")
    } catch (e) {
        console.error(e)
    }
    e.on("pushMessage", function (e) {
        var t = showNotify({title: "小喇叭开始广播辣", content: e.markdown});
        null !== t && (t.onclick = function () {
            window.open("/talk.html")
        }), console.info(e)
    }), e.on("pushLogMessage", function (e, t) {
        0 === e ? (outPutSuccess(t), $.notify(moment().format("YYYY-MM-DD HH:mm:ss") + `
` + t, "success")) : 1 === e ? (outPutInfo(t), $.notify(moment().format("YYYY-MM-DD HH:mm:ss") + `
` + t, "warn")) : 2 === e && (outPutError(t), $.notify(moment().format("YYYY-MM-DD HH:mm:ss") + `
` + t, "error"))
    });
    let a = null;

    function o() {
        e.invoke("getRunTime")
    }

    e.on("cnBetaSubscribe", function (t) {
        var o = [];
        if (t.hasOwnProperty("progressValues") && Array.isArray(t.progressValues)) for (let e = 0; e < t.progressValues.length; e++) {
            var n = (100 * t.progressValues[e]).toFixed(2);
            o.push(parseFloat(n))
        }
        switch (null == a ? a = notification.show({
            title: "CnBeta发布",
            content: t.message,
            bars: o
        }) : (notification.setContent(a, t.message), notification.setProgress(a, o)), t.type) {
            case 0:
                outPutSuccess(t.message);
                break;
            case 1:
                outPutInfo(t.message);
                break;
            case 2:
                outPutError(t.message);
                break;
            case 3:
                outPutSuccess(t.message), setTimeout(function () {
                    notification.close(a), a = null
                }, 1e3)
        }
    }), e.on("ready", function (e) {
        console.info(e)
    }), setTimeout(function () {
        o()
    }, 1e3), e.on("ReceiveRunTime", function (e) {
        var t = $("#runTime");
        0 < t.length && (t.text("运行时间 " + e), setTimeout(o, 1e3))
    })
}();
let notification = {
    show: function (e) {
        "object" != typeof e && (e = {});
        let l = {title: "", content: "", bars: []}, t = ($.extend(l, e), 0);
        $(".notification-box").each(function () {
            t += $(this).height() + 15
        });
        e = function (e, t) {
            var o = $("<div>").addClass("notification-box"), e = $("<div>").addClass("title").text(e),
                n = (o.append(e), $("<div>").addClass("content-container")),
                e = $("<span>").addClass("content").text(t), a = (n.append(e), function (t) {
                    var o = [];
                    if (Array.isArray(t)) for (let e = 0; e < t.length; e++) "number" == typeof t[e] && o.push(t[e]);
                    return o
                }(l.bars));
            for (let e = 0; e < a.length; e++) {
                var i = $("<div>").addClass("progress"), s = a[e] + "%",
                    s = $("<div>").addClass("bar").css("width", s).text(s);
                i.append(s), n.append(i)
            }
            return o.append(n), o
        }(l.title, l.content);
        return e.css("top", t + 15 + "px"), $("body").append(e), e
    }, setContent: function (e, t) {
        0 !== e.length && e.find(".content").text(t)
    }, setTitle: function (e, t) {
        0 !== e.length && e.find(".title").text(t)
    }, setProgress: function (o, n) {
        if (0 !== o.length && Array.isArray(n)) {
            let t = 0;
            for (let e = 0; e < n.length; e++) "number" == typeof n[e] && (o.find(`.content-container .progress:eq(${t}) .bar`).css("width", n[e] + "%").text(n[e] + "%"), t++)
        }
    }, close: function (e) {
        0 !== e.length && e.fadeOut("fast", function () {
            e.remove()
        })
    }, closeAll: function () {
        $(".notification-box").fadeOut("fast", function () {
            $(".notification-box").remove()
        })
    }, test: function () {
        let t = notification.show({title: "这是标题呀", content: "内容", bars: [0]}), o = (setTimeout(function e() {
            if (100 <= o) return notification.setContent(t, "加载完毕，即将关闭！"), void notification.close(t);
            o++;
            notification.setContent(t, "新内容呀\n" + o);
            notification.setProgress(t, [o]);
            setTimeout(e, 100)
        }, 100), 0)
    }
};
//# sourceMappingURL=site.min.js.map