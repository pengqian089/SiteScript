class AudioRecorder{constructor(e={}){this.options=Object.assign({onMessage:(e,t)=>console.log(e,t),onLoading:(e,t)=>{}},e),this.config={MAX_DURATION:600,MIN_DURATION:1,AUDIO_TYPE:"audio/webm;codecs=opus",FALLBACK_TYPE:"audio/wav",UPDATE_INTERVAL:100},this.media={mediaRecorder:null,audioChunks:[],audioUrl:null,audioBlob:null,stream:null,audioElement:null},this.state={isRecording:!1,isPaused:!1,isPlaying:!1,duration:0,currentTime:0,startTime:null,recordingTimer:null,playbackTimer:null,hasRecording:!1},this.selectors={startBtn:"#startRecording",stopBtn:"#stopRecording",playBtn:"#playRecording",pauseBtn:"#pauseRecording",clearBtn:"#clearRecording",uploadBtn:"#uploadRecording",recordingSection:".recording-section",playerSection:"#recordingPlayer",statusText:"#recordingStatusText",recordingTime:"#recordingTime",currentTime:"#currentTime",totalTime:"#totalTime",progressBar:"#audioProgressBar",progressHandle:"#audioProgressHandle",progressContainer:"#audioProgress"}}init(){this.bindEvents(),this.resetState()}bindEvents(){$(this.selectors.startBtn).on("click",()=>this.startRecording()),$(this.selectors.stopBtn).on("click",()=>this.stopRecording()),$(this.selectors.playBtn).on("click",()=>this.togglePlayback()),$(this.selectors.pauseBtn).on("click",()=>this.pausePlayback()),$(this.selectors.clearBtn).on("click",()=>this.clearRecording()),$(this.selectors.uploadBtn).on("click",()=>this.uploadRecording()),this.bindProgressBarEvents()}resetState(){this.stopRecording(),this.stopPlayback(),this.cleanupMediaResources(),this.state={isRecording:!1,isPaused:!1,isPlaying:!1,duration:0,currentTime:0,startTime:null,recordingTimer:null,playbackTimer:null,hasRecording:!1},this.updateUI()}cleanupMediaResources(){this.media.stream&&(this.media.stream.getTracks().forEach(e=>e.stop()),this.media.stream=null),this.media.audioUrl&&(URL.revokeObjectURL(this.media.audioUrl),this.media.audioUrl=null),this.media.mediaRecorder=null,this.media.audioChunks=[],this.media.audioBlob=null,this.media.audioElement=null}async startRecording(){try{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var t=await navigator.mediaDevices.getUserMedia({audio:!0});this.media.stream=t;let e=MediaRecorder.isTypeSupported(this.config.AUDIO_TYPE)?this.config.AUDIO_TYPE:this.config.FALLBACK_TYPE;this.media.mediaRecorder=new MediaRecorder(t,{mimeType:e}),this.media.audioChunks=[],this.media.mediaRecorder.ondataavailable=e=>{0<e.data.size&&this.media.audioChunks.push(e.data)},this.media.mediaRecorder.onstop=()=>{this.processRecordedAudio(e)},this.media.mediaRecorder.start(),this.state.isRecording=!0,this.state.startTime=Date.now(),this.startRecordingTimer(),this.updateUI()}else this.options.onMessage("浏览器不支持录音功能","error")}catch(e){console.error("录音启动失败:",e),this.options.onMessage("无法启动录音，请检查麦克风权限","error")}}stopRecording(){this.media.mediaRecorder&&this.state.isRecording&&(this.media.mediaRecorder.stop(),this.state.isRecording=!1,this.stopRecordingTimer(),this.media.stream)&&(this.media.stream.getTracks().forEach(e=>e.stop()),this.media.stream=null)}startRecordingTimer(){this.stopRecordingTimer(),this.state.recordingTimer=setInterval(()=>{var e=(Date.now()-this.state.startTime)/1e3;this.state.duration=e,this.updateTimeDisplay(e,this.selectors.recordingTime),e>=this.config.MAX_DURATION&&(this.stopRecording(),this.options.onMessage("已达到最大录音时长","info"))},this.config.UPDATE_INTERVAL)}stopRecordingTimer(){this.state.recordingTimer&&(clearInterval(this.state.recordingTimer),this.state.recordingTimer=null)}processRecordedAudio(e){this.media.audioBlob=new Blob(this.media.audioChunks,{type:e}),this.media.audioUrl=URL.createObjectURL(this.media.audioBlob),this.media.audioElement=new Audio(this.media.audioUrl),this.media.audioElement.onended=()=>{this.state.isPlaying=!1,this.stopPlaybackTimer(),this.state.currentTime=0,this.updateUI()},this.media.audioElement.onloadedmetadata=()=>{this.media.audioElement.duration&&isNaN(this.media.audioElement.duration)},this.state.hasRecording=!0,this.updateUI()}togglePlayback(){this.media.audioElement&&(this.state.isPlaying?this.pausePlayback():this.startPlayback())}startPlayback(){this.media.audioElement&&(this.media.audioElement.play(),this.state.isPlaying=!0,this.startPlaybackTimer(),this.updateUI())}pausePlayback(){this.media.audioElement&&(this.media.audioElement.pause(),this.state.isPlaying=!1,this.stopPlaybackTimer(),this.updateUI())}stopPlayback(){this.media.audioElement&&(this.media.audioElement.pause(),this.media.audioElement.currentTime=0,this.state.isPlaying=!1,this.stopPlaybackTimer(),this.state.currentTime=0,this.updateUI())}startPlaybackTimer(){this.stopPlaybackTimer(),this.state.playbackTimer=setInterval(()=>{this.media.audioElement&&(this.state.currentTime=this.media.audioElement.currentTime,this.updateTimeDisplay(this.state.currentTime,this.selectors.currentTime),this.updatePlaybackProgress())},this.config.UPDATE_INTERVAL)}stopPlaybackTimer(){this.state.playbackTimer&&(clearInterval(this.state.playbackTimer),this.state.playbackTimer=null)}clearRecording(){confirm("确定要清除当前录音吗？")&&this.resetState()}async uploadRecording(){if(this.media.audioBlob){let e="webm";this.media.audioBlob.type.includes("wav")?e="wav":this.media.audioBlob.type.includes("mp3")?e="mp3":this.media.audioBlob.type.includes("flac")&&(e="flac");var t=new FormData;t.append("record",this.media.audioBlob,"recording."+e),t.append("duration",this.state.duration.toString());try{"undefined"!=typeof memberCenter&&memberCenter.showProgress?memberCenter.showProgress("正在上传录音..."):this.options.onLoading(!0,"正在上传...");var s=await this.uploadWithProgress("/Audio/Upload",t,e=>{"undefined"!=typeof memberCenter&&memberCenter.updateProgress&&memberCenter.updateProgress(e,"正在上传录音...")});"undefined"!=typeof memberCenter&&memberCenter.hideProgress?memberCenter.hideProgress():this.options.onLoading(!1),s.success?(this.options.onMessage("录音上传成功","success"),s.data&&s.data.accessUrl&&this.insertAudioToEditor(s.data.accessUrl),this.resetState()):this.options.onMessage(s.msg||"上传失败","error")}catch(e){"undefined"!=typeof memberCenter&&memberCenter.hideProgress?memberCenter.hideProgress():this.options.onLoading(!1),this.options.onMessage("上传失败: "+e.message,"error"),console.error("上传录音失败:",e)}}else this.options.onMessage("没有可上传的录音","warning")}updateUI(){var{isRecording:e,hasRecording:t,isPlaying:s,duration:i,currentTime:a}=this.state;$(this.selectors.startBtn).toggle(!e&&!t),$(this.selectors.stopBtn).toggle(e),$(this.selectors.playBtn).toggle(t&&!s),$(this.selectors.pauseBtn).toggle(t&&s),$(this.selectors.clearBtn).toggle(t&&!e),$(this.selectors.uploadBtn).toggle(t&&!e),t?$(this.selectors.playerSection).slideDown():$(this.selectors.playerSection).slideUp(),e?($(this.selectors.statusText).text("正在录音..."),$(this.selectors.recordingSection).addClass("recording")):($(this.selectors.statusText).text(t?"录音完成":"准备录音"),$(this.selectors.recordingSection).removeClass("recording")),this.updateTimeDisplay(i,this.selectors.totalTime),this.updateTimeDisplay(a,this.selectors.currentTime),this.updatePlaybackProgress()}updateTimeDisplay(e,t){var s=Math.floor(e/60),e=Math.floor(e%60);$(t).text(s.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0"))}updatePlaybackProgress(){var e;0<this.state.duration?(e=this.state.currentTime/this.state.duration*100,$(this.selectors.progressBar).css("width",e+"%"),$(this.selectors.progressHandle).css("left",e+"%")):($(this.selectors.progressBar).css("width","0%"),$(this.selectors.progressHandle).css("left","0%"))}bindProgressBarEvents(){let t=!1;$(this.selectors.progressContainer).on("mousedown touchstart",e=>{this.state.hasRecording&&(t=!0,this.handleSeek(e))}),$(document).on("mousemove touchmove",e=>{t&&(e.preventDefault(),this.handleSeek(e))}),$(document).on("mouseup touchend",()=>{t=!1})}handleSeek(e){var t=$(this.selectors.progressContainer),s=t.offset(),t=t.width();let i=e.clientX;e=((i=e.type.includes("touch")?e.touches[0].clientX:i)-s.left)/t,s=Math.max(0,Math.min(1,e))*this.state.duration;this.seekTo(s)}seekTo(e){this.media.audioElement&&(this.media.audioElement.currentTime=e,this.state.currentTime=e,this.updateTimeDisplay(e,this.selectors.currentTime),this.updatePlaybackProgress())}uploadWithProgress(e,a,r){return new Promise((t,s)=>{let i=new XMLHttpRequest;i.open("POST",e,!0),i.upload&&r&&(i.upload.onprogress=e=>{e.lengthComputable&&(e=Math.round(e.loaded/e.total*100),r(e))}),i.onload=()=>{if(200<=i.status&&i.status<300)try{var e=JSON.parse(i.responseText);t(e)}catch(e){s(new Error("Invalid JSON response"))}else s(new Error("Upload failed with status "+i.status))},i.onerror=()=>s(new Error("Network error")),i.send(a)})}insertAudioToEditor(e){try{var t,s,i,a=`
<audio controls src="${e}" style="max-width: 100%; margin: 10px 0;"></audio>
`;"undefined"!=typeof memberCenter&&memberCenter.cherryInstance?(t=memberCenter.cherryInstance.getMarkdown(),memberCenter.cherryInstance.setMarkdown(t+a)):(s=document.getElementById("mumbleContent")||document.getElementById("articleContent")||document.getElementById("timelineContent"))&&(i=s.value||"",s.value=i+a)}catch(e){console.error("插入音频标签失败:",e)}}}
//# sourceMappingURL=member.min.js.map